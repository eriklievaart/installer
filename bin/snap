#!/bin/sh
set -e

getdisplay() {
	count=1
	echo "$allbounds" | while read -r dw dh dx dy
	do 
		result=$(echo "${wmidx?} >= ${dx?} && ${wmidx?} < ${dx?} + ${dw?}" | bc)
		if [ 1 -eq $result ]; then
			echo "$count"
			return 0;
		fi
		count=$(expr "${count?}" '+' '1')
	done
}
id=$(xprop -root | sed -r -n '/ACTIVE_WINDOW\(/{s|[^#]*# ?0x||;p}')
line=$(wmctrl -l -G | grep "$id")

# current bounds of window
wx=$(echo "$line" | awk '{print $3}')
wy=$(echo "$line" | awk '{print $4}')
ww=$(echo "$line" | awk '{print $5}')
wh=$(echo "$line" | awk '{print $6}')
allbounds=$(xrandr | grep " connected " | awk '{print $3}'  | tr '+x' '  ')
wmidx=$(echo "$ww / 2 + $wx" | bc)
display=$(getdisplay)
displaymax=$(echo " $allbounds " | wc -l)
echo "window x $wx midx $wmidx display $display max $displaymax"

# scaling factor for x, y, width & height
fx=0
fy=0
fw=1
fh=1
maximize=remove

while true
do
        case "$1" in
                -f) wmctrl -r :ACTIVE: -b toggle,fullscreen; exit 0;;
                -m) maximize=add;;
                -l) fw="0.5";;
                -r) fw="0.5"; fx="0.5";;
                -t) fh="0.5";;
                -b) fh="0.5"; fy="0.5";;
		-n) display=$(echo "(${display?} + 1) % ${displaymax?}" | bc);;
		-p) display=$(echo "(${display?} - 1) % ${displaymax?}" | bc);;
        esac
	[ $display -eq 0 ] && display=$displaymax
	if [ "$#" -eq 0 ]; then
		
		dw=$(echo "$allbounds" | sed "${display?}!d" | cut -d ' ' -f 1)
		dh=$(echo "$allbounds" | sed "${display?}!d" | cut -d ' ' -f 2)
		dx=$(echo "$allbounds" | sed "${display?}!d" | cut -d ' ' -f 3)
		dy=$(echo "$allbounds" | sed "${display?}!d" | cut -d ' ' -f 4)
		echo "destination display[$display] bounds ${dx?} ${dy?} ${dw?} ${dh?}"

		x=$(echo "${fx?} * ${dw?} + ${dx?}" | bc | cut -d '.' -f 1)
		y=$(echo "${fy?} * ${dh?} + ${dy?}" | bc | cut -d '.' -f 1)
		w=$(echo "${fw?} * $dw" | bc | cut -d '.' -f 1)
		h=$(echo "${fh?} * $dh" | bc | cut -d '.' -f 1)
		echo "window destination bounds ${x?} ${y?} ${w?} ${h?}"

		wmctrl -r :ACTIVE: -b remove,fullscreen
		wmctrl -r :ACTIVE: -b remove,maximized_vert,maximized_horz;
		wmctrl -r :ACTIVE: -e "0,$x,$y,$w,$h"
		if [ "$maximize" = "add" ]; then
			wmctrl -r :ACTIVE: -b add,maximized_vert,maximized_horz;
		fi
		stop=$(($(date +%s%N)/1000000))
		exit 0
	fi
        shift
done

